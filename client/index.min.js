var socket=null;var bconnected=false;var timerHeartBeat=null;$(function(){$("#localid").val(getLocalID());setState(false)});function getTime(){var a=new Date();return a.toLocaleString()}function scroll2End(){$("#contentScroll")[0].scrollTop=$("#contentScroll")[0].scrollHeight}function getLocalID(){var c=["0","1","2","3","4","5","6","7","8","9"];var b="";for(var a=0;a<5;a++){var d=Math.ceil(Math.random()*9);b+=c[d]}return b}function setState(a){if(a){$("#listenBtn").attr("disabled",true);$("#stopBtn").attr("disabled",false);$("#sendBtn").attr("disabled",false);$("#remoteid").attr("disabled",false);$("#serverip").attr("disabled",true);$("#localid").attr("disabled",true);bconnected=true}else{$("#listenBtn").attr("disabled",false);$("#stopBtn").attr("disabled",true);$("#sendBtn").attr("disabled",true);$("#remoteid").attr("disabled",false);$("#serverip").attr("disabled",false);$("#localid").attr("disabled",false);bconnected=false}}function sendmsg(){var a=$("#remoteid").val();var b=$("#localid").val();var d=encodeScript($("#msg").val());if(b.length<1){alert("请输入对方聊天ID！！！");return}if(a==b){alert("请不要给自己发消息！！！");return}if(d.length<1){alert("请不要发送空消息！！！");return}var c={"msgType":"TRANS2USER","msgRemote":a,"msgBody":d};c=JSON.stringify(c);socket.send(c);$("#content").append("<kbd>"+getTime()+" 发送消息["+d+"]到用户["+a+"]</kbd></br>");scroll2End();$("#msg").val("");heartbeat()}function heartbeat(){if(timerHeartBeat!=null){window.clearInterval(timerHeartBeat);timerHeartBeat=null}timerHeartBeat=window.setInterval(function(){var a={"msgType":"HEARTBEAT","msgRemote":"10000","msgBody":""};a=JSON.stringify(a);socket.send(a);$("#content").append("<kbd>"+getTime()+" 向服务器发送心跳包！</kbd></br>")},30000)}function listen(){$("#listenBtn").attr("disabled",true);$("#stopBtn").attr("disabled",true);$("#sendBtn").attr("disabled",true);$("#remoteid").attr("disabled",true);$("#serverip").attr("disabled",true);$("#localid").attr("disabled",true);var a=$("#serverip").val();var b=$("#localid").val();if(a.length>0&&b.length>0){socket=new WebSocket("ws://"+a);socket.onopen=function(){$("#content").append("<kbd>"+getTime()+" 连接服务器成功！</kbd></br>");scroll2End();var c={"msgType":"LOGIN","msgRemote":"10000","msgBody":b};c=JSON.stringify(c);socket.send(c);setState(true);heartbeat()};socket.onmessage=function(c){var d=JSON.parse(c.data);if(d.msgRemote=="10000"){if(d.msgType=="LOGIN"){if(d.msgBody=="OK"){$("#content").append("<kbd>"+getTime()+" 登录成功！</kbd></br>")}else{if(d.msgBody=="RECONNECT"){$("#content").append("<kbd>"+getTime()+" 不允许重复登录！</kbd></br>")}}}else{if(d.msgType=="HEARTBEAT"){$("#content").append("<kbd>"+getTime()+" 接收到服务器心跳包！</kbd></br>")}}}else{if(d.msgType=="TRANS2USER"){$("#content").append("<kbd>"+getTime()+" 接收到来自["+d.msgRemote+"]的消息["+d.msgBody+"]</kbd></br>")}else{if(d.msgType=="REMOTEOFFLINE"){$("#content").append("<kbd>"+getTime()+" ["+d.msgRemote+"]当前不在线</kbd></br>")}}}scroll2End()};socket.onclose=function(c){if(bconnected){$("#content").append("<kbd>"+getTime()+" 连接关闭！"+"</kbd></br>");scroll2End()}setState(false);if(timerHeartBeat){window.clearInterval(timerHeartBeat);timerHeartBeat=null}};socket.onerror=function(c){if(bconnected){$("#content").append("<kbd>"+getTime()+" 连接关闭！"+"</kbd></br>");scroll2End()}else{$("#content").append("<kbd>"+getTime()+" 无法连接到服务器！"+"</kbd></br>");scroll2End()}setState(false);if(timerHeartBeat){window.clearInterval(timerHeartBeat);timerHeartBeat=null}}}else{setState(false);alert("请正确输入服务器信息（例如：192.168.1.10:8000）和本机用户ID（例如：123456）")}}function stop(){if(bconnected&&socket!=null){socket.close()}}function encodeScript(a){if(null==a||""==a){return""}return a.replace("<","&lt;").replace(">","&gt;")}document.onkeydown=function(a){var b=a||window.event||arguments.callee.caller.arguments[0];if(b&&b.keyCode==13){sendmsg()}};